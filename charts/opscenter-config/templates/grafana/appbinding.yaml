apiVersion: appcatalog.appscode.com/v1alpha1
kind: AppBinding
metadata:
  name: {{ include "opscenter-config.fullname" . }}-grafana
  namespace: {{ .Release.Namespace }}
{{- if .Values.grafana.default }}
  annotations:
    monitoring.appscode.com/is-default-grafana: "true"
{{- end }}
  labels:
    {{- include "opscenter-config.labels" . | nindent 4 }}
spec:
  type: Grafana
  clientConfig:
  {{- if .Values.grafana.url }}
    url: {{ .Values.grafana.url }}
  {{- else }}
    service:
      scheme: {{ .Values.grafana.service.scheme }}
      name: {{ .Values.grafana.service.name }}
      namespace: {{ .Values.grafana.service.namespace }}
      port: {{ .Values.grafana.service.port }}
    {{- with .Values.grafana.service.path }}
      path: {{ . }}
    {{- end }}
    {{- with .Values.grafana.service.query }}
      query: {{ . }}
    {{- end }}
  {{- end }}
{{- if or .Values.grafana.basicAuth.password .Values.grafana.bearerToken }}
  secret:
    name: {{ include "opscenter-config.fullname" . }}-grafana-auth
{{- end }}
{{- if .Values.grafana.tls.ca }}
  clientCertificateSecret:
    name: {{ include "opscenter-config.fullname" . }}-grafana-tls
{{- end }}
{{- if .Values.grafana.tls.insecureSkipTLSVerify }}
  insecureSkipTLSVerify: true
{{- end }}
{{- with .Values.grafana.tls.ca }}
  caBundle: {{ . | b64enc }}
{{- end }}
{{- with .Values.grafana.tls.serverName }}
  serverName: {{ . }}
{{- end }}
{{- if or .Values.grafana.dashboard.datasource .Values.grafana.dashboard.folderID }}
  parameters:
    apiVersion: openviz.dev/v1alpha1
    kind: DatasourceConfiguration
  {{- with .Values.grafana.dashboard.datasource }}
    datasource: {{ . }}
  {{- end }}
  {{- with .Values.grafana.dashboard.folderID }}
    folderID: {{ . }}
  {{- end }}
{{- end }}

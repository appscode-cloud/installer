apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
  name: {{ include "tenant.name" . }}
  annotations:
    {{- dict "catalog.appscode.com/gateway-config" (dict "service" .Values.envoy.service "vaultServer" .Values.vaultServer | toYaml) | toYaml | nindent 4 }}
    {{- with .Values.gatewayClass.annotations }}
      {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  controllerName: {{ .Values.gateway.config.envoyGateway.gateway.controllerName }}
  {{- with .Values.gatewayClass.description }}
  description: {{ . | quote }}
  {{- end }}
  parametersRef:
    group: gateway.envoyproxy.io
    kind: EnvoyProxy
    name: {{ include "tenant.name" . }}
    namespace: {{ .Release.Namespace }}
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: {{ include "tenant.name" . }}
  namespace: {{ .Release.Namespace }}
spec:
  mergeGateways: true
  provider:
    type: Kubernetes
    kubernetes:
      envoyDeployment:
        container:
          image: "{{ .Values.envoy.image }}:{{ .Values.envoy.tag }}"
          securityContext:
            {{- toYaml .Values.envoy.securityContext | nindent 12 }}
        patch:
          value:
            spec:
              template:
                spec:
                  containers:
                  - name: shutdown-manager
                    securityContext:
                      {{- toYaml .Values.envoy.securityContext | nindent 22 }}

    {{- if eq .Values.infra.hostType "domain" }}
      envoyService:
        annotations:
          external-dns.alpha.kubernetes.io/hostname: {{ include "gateway.domain" . }}
    {{- end }}
